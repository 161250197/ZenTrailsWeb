!function(){"use strict";var t={245:function(t){t.exports=JSON.parse('{"dotRadius":5,"defaultColor":"#888888"}')}},n={};function o(e){var i=n[e];if(void 0!==i)return i.exports;var r=n[e]={exports:{}};return t[e](r,r.exports,o),r.exports}!function(){function t(t){return t*Math.PI/180}function n({x:t,y:n},o,e,i=0){e+=i;const r=t-o.x,c=n-o.y;return e*e>=r*r+c*c}function e(t,n){return function(t){return 180*t/Math.PI}(function(t,n){const o=n.x-t.x,e=n.y-t.y;let i=Math.atan(e/o);return o<0&&(i+=Math.PI),i}(t,n))}function i(n,o,e){const{x:i,y:r}=n,c=t(o);return{x:i+Math.cos(c)*e,y:r+Math.sin(c)*e}}function r(t){function n(t){return 10*Math.round(t/10)}let{x:o,y:e}=t;return o=n(o),e=n(e),{x:o,y:e}}function c(t,n){let o=(r=n,c=t,Math.sqrt(function(t,n){const o=n.x-t.x,e=n.y-t.y;return o*o+e*e}(r,c)));var r,c,s;s=o,o=10*Math.ceil(s/10);let a=e(n,t);return a=function(t,n){const o=[50,100,200];let e=0;for(;e<o.length&&o[e]<n;)e++;const i=[30,20,10,5][e];return Math.round(t/i)*i}(a,o),{position:t=i(n,a,o),radius:o,angle:a}}const{defaultColor:s}=o(245),{getLastColor:a,setLastColor:u}=function(){let t=s;return{getLastColor:function(){return t},setLastColor:function(n){t=n}}}(),{dotRadius:l}=o(245);class d{constructor(t){const n=r(t);this.firstDot=new h(n,this)}selectDot(t){const o=[],e=2*l,{firstDot:i}=this;n(t,i,e)&&o.push(i);let r=[i];for(;r.length;){let i=[];for(const t of r)i=i.concat(t.followDots);r=i;for(const i of r)n(t,i,e)&&o.push(i)}return o}reset(){let t=[this.firstDot];for(;t.length;){let n=[];for(const o of t)n=n.concat(o.followDots);t=n;for(const n of t)n.reset()}}updateCartoonPath(){let t=this.firstDot.followDots;for(;t.length;){let n=[];for(const o of t)n=n.concat(o.followDots),o.updateDurationState(10);t=n}}drawCartoonPath(t){let n=this.firstDot.followDots;for(;n.length;){let o=[];for(const e of n)o=o.concat(e.followDots),e.drawCartoonPath(t);n=o}}drawPathDots(t){const{firstDot:n}=this;t.drawPathFirstDot(n);let o=n.followDots;for(;o.length;){let n=[];for(const e of o)n=n.concat(e.followDots),t.drawPathFollowDot(e);o=n}}}class f{constructor({x:t,y:n}){this.x=t,this.y=n,this.followDots=[],this.isTarget=!1,this.opacity=1}appendDot(t){const n=c(t,this),o=new p(n,this);return this.followDots.push(o),o}removeDot(){throw Error("removeDot 未实现")}}class h extends f{constructor(t,n){super(t),this.path=n}removeDot(){!function(t){const n=ct.indexOf(t);ct.splice(n,1)}(this.path)}}class p extends f{constructor({position:t,radius:n,angle:o},e){super(t),this.radius=n,this.angle=o,this.angleVelocity=10,this.isAntiClockwise=!1,this.color=a(),this.lastDot=e;const{x:i,y:r}=t;this.__initialState={x:i,y:r,angle:o}}reset(){this.setState(this.__initialState)}setState({x:t,y:n,angle:o}){this.x=t,this.y=n,this.angle=o}removeDot(){const t=this.lastDot.followDots,n=t.indexOf(this);return t.splice(n,1),this.lastDot}drawCartoonPath(t){t.drawCartoonPath(this,this.__lastState)}updateDurationState(t){this.__saveLastState();const n=this.__calDurationState(t);this.setState(n)}__saveLastState(){const{x:t,y:n,angle:o}=this;this.__lastState={x:t,y:n,angle:o}}__calDurationState(t){const{radius:n,angleVelocity:o,lastDot:e}=this,r=o*t/100,c=this.angle+(this.isAntiClockwise?-r:r),{x:s,y:a}=i(e,c,n);return{x:s,y:a,angle:c}}}function _(t){return g(t),t.preventDefault(),t.stopPropagation(),!1}function w(t){t.addEventListener("click",g),t.addEventListener("auxclick",g),t.addEventListener("dblclick",g),t.addEventListener("mousemove",g)}function g(t){t.__eventUsed=!0}function m(t){return!!t.__eventUsed}function v(t,n){return function(){const o=t();return n((function(){return o})),o}}const y="hide";function D(t){C(t,y)}function x(t){E(t,y)}function C(t,n){t.classList.add(n)}function E(t,n){t.classList.remove(n)}function L(){}const S=function(){const t=document.createElement("a");return(n,o)=>{t.download=n,t.href=o,t.click()}}();function b(t){const{clientX:n,clientY:o}=t.touches&&t.touches[0]?t.touches[0]:t;return{x:n,y:o}}let I=v((function(){return document.getElementById("canvas-wrapper")}),(t=>I=t)),k=v((function(){return document.getElementById("export-canvas")}),(t=>k=t)),P=v((function(){return document.getElementById("up-canvas")}),(t=>P=t)),M=v((function(){return document.getElementById("down-canvas")}),(t=>M=t));function T(){const t=I(),{offsetWidth:n,offsetHeight:o}=t;return{width:n,height:o}}function F(){const{width:t,height:n}=T();[k(),M(),P()].forEach((o=>{o.width=t,o.height=n,function(t,n){const o=n instanceof Array?n.join("; "):n;t.setAttribute("style",o)}(o,[`width: ${t}px`,`height: ${n}px`])}))}const{dotRadius:A,defaultColor:R}=o(245);class W{constructor(t){const n=t.getContext("2d");n.lineJoin="round",n.lineWidth=3,this.__ctx=n}__drawLine(t,n){this.startPath(t),this.concatDot(n),this.closePath()}__drawCircle({x:t,y:n},o,e=0,i=2*Math.PI,r){const{__ctx:c}=this;c.beginPath(),c.arc(t,n,o,e,i,r),c.stroke(),c.closePath()}__createDotRadialGradient({x:t,y:n,color:o=R}){const e=A,i=this.__ctx.createRadialGradient(t,n,0,t,n,e);return i.addColorStop(0,"#bbbbbb"),i.addColorStop(.2,o),i.addColorStop(.8,o),i.addColorStop(.9,"white"),i.addColorStop(.9,"transparent"),i}__createDotLinearGradient({x:t,y:n,color:o,lastDot:e}){const i=e.color||R,r=this.__ctx.createLinearGradient(e.x,e.y,t,n);return r.addColorStop(0,i),r.addColorStop(.2,i),r.addColorStop(.8,o),r.addColorStop(1,o),r}__drawDotFunc(t){const{__ctx:n}=this;n.save(),n.fillStyle=this.__createDotRadialGradient(t);const{x:o,y:e,opacity:i}=t;n.globalAlpha=i,n.fillRect(o-A,e-A,2*A,2*A),n.restore()}__drawLastDotToDotLine(t){const{__ctx:n}=this;n.save(),n.lineWidth=1,n.globalAlpha=.6,n.strokeStyle=this.__createDotLinearGradient(t),this.__drawLine(t.lastDot,t),n.restore()}__drawDotDirection(n){const{__ctx:o}=this;o.save();const{color:e,angle:i,isAntiClockwise:r}=n,c=t(i),s=c+Math.PI/6,a=c+Math.PI;o.strokeStyle=e,o.lineWidth=5,this.__drawCircle(n,A,s,a,r),o.strokeStyle="white",o.lineWidth=1,this.__drawCircle(n,A,s,a,r),o.restore()}drawMouseMoveSelectDot(t){const{__ctx:n}=this;n.save(),this.drawTargetDot(t,.4),n.restore()}drawMouseMoveFollowDot(t,n){const{__ctx:o}=this;o.save();const e={...t,color:a(),opacity:.6,lastDot:n};this.__drawLastDotToDotLine(e),this.__drawDotFunc(e),this.drawTargetDot(e,.4),o.restore()}drawMouseMoveFirstDot(t){const{__ctx:n}=this;n.save();const o={...t,color:R,opacity:.6};this.__drawDotFunc(o),this.drawTargetDot(o,.4),n.restore()}drawTargetDot(t,n){const{__ctx:o}=this;o.save(),o.lineWidth=5,o.globalAlpha=n||.6,o.strokeStyle=t.color||R,this.__drawCircle(t,A),o.lineWidth=1,o.strokeStyle="white",this.__drawCircle(t,A),o.restore()}drawPathFirstDot(t){this.__drawDotFunc(t)}drawPathFollowDot(t){this.__drawLastDotToDotLine(t),this.__drawDotDirection(t),this.__drawDotFunc(t)}drawCartoonPath(t,n){const{__ctx:o}=this;o.save();const{color:e,opacity:i}=t;o.strokeStyle=e,o.globalAlpha=i,this.__drawLine(t,n),o.restore()}startPath({x:t,y:n}){const{__ctx:o}=this;o.beginPath(),o.moveTo(t,n)}concatDot({x:t,y:n}){const{__ctx:o}=this;o.lineTo(t,n),o.stroke()}closePath(){this.__ctx.closePath()}clearCanvas(){const t=Number.MAX_SAFE_INTEGER;this.__ctx.clearRect(0,0,t,t)}drawWhiteShadow(){const{__ctx:t}=this;t.save(),t.fillStyle="white",t.globalAlpha=.01;const n=Number.MAX_SAFE_INTEGER;t.fillRect(0,0,n,n),t.restore()}getImageData({width:t,height:n}){return this.__ctx.getImageData(0,0,t,n)}putImageData(t){this.__ctx.putImageData(t,0,0)}}let B=v((function(){return new W(k())}),(t=>B=t)),N=v((function(){return new W(P())}),(t=>N=t)),q=v((function(){return new W(M())}),(t=>q=t));function j(){B().clearCanvas(),N().clearCanvas(),q().clearCanvas()}let G,V=v((function(){return document.getElementById("setting-wrapper")}),(t=>V=t)),$=v((function(){return document.querySelector("#setting-wrapper .color")}),(t=>$=t)),H=v((function(){return document.querySelector("#setting-wrapper .opacity")}),(t=>H=t)),U=v((function(){return document.querySelector("#setting-wrapper .direction")}),(t=>U=t)),Z=v((function(){return document.querySelector("#setting-wrapper .velocity")}),(t=>Z=t)),O=v((function(){return document.querySelector("#setting-wrapper .remove")}),(t=>O=t)),X=v((function(){return document.querySelector("#setting-wrapper .first-dot-setting")}),(t=>X=t)),J=v((function(){return document.querySelector("#setting-wrapper .follow-dot-setting")}),(t=>J=t));function z(){w(V());$().addEventListener("input",(t=>{const n=t.target.value;Y().color=n,u(n),mt()}),!1);H().addEventListener("input",(t=>{const n=t.target.value;Y().opacity=n/100,mt()}));U().addEventListener("click",(()=>{const t=Y();t.isAntiClockwise=!t.isAntiClockwise,K(t),mt()}));Z().addEventListener("input",(t=>{const n=t.target.value;Y().angleVelocity=n}));O().addEventListener("click",(()=>{!function(){if(void 0===G)return;const t=G.removeDot();void 0===t?tt():Q(t)}()}))}function K(t){const n=U(),o="is-clockwise",e="is-anti-clockwise";E(n,o),E(n,e),C(n,t.isAntiClockwise?e:o)}function Y(){return G}function Q(t){var n;void 0!==G&&(G.isTarget=!1),G=t,G instanceof h?(D(J()),x(X()),x(V())):(n=G,$().value=n.color,H().value=100*n.opacity,K(n),Z().value=n.angleVelocity,D(X()),x(J()),x(V())),G.isTarget=!0,mt()}function tt(){void 0!==G?(G.isTarget=!1,D(V()),G=void 0,mt()):mt()}function nt(t){let n=[];const o=st();for(const e of o)n=n.concat(e.selectDot(t));let e;return n.length&&(e=n[0]),e}let ot=v((function(){return document.getElementById("data-upload-btn")}),(t=>ot=t)),et=v((function(){return document.getElementById("data-save-btn")}),(t=>et=t));const it=function(){const t=document.createElement("input");t.type="file",t.accept=".ZenTrailsWeb",t.addEventListener("change",(function(){if(0===t.files.length)return;const o=t.files[0];n.readAsText(o),t.value=null}));const n=new FileReader;return n.onload=function(){at(function(){const t=[],o=(e=n.result,decodeURIComponent(e));var e;const[i,r,c]=o.split("\n"),s=function(){const t={},n=i.split(";").map((t=>{const[n,o]=t.split(" ");return{id:n,followIds:o.split(",")}}));for(const{id:o,followIds:e}of n)t[o]=e;return t}(),a=r.split(";").map((n=>{const[o,e,i]=n.split(" "),r=Number(e),c=Number(i),s=new d({x:r,y:c});return t.push(s),{id:o,dot:s.firstDot}})),u=function(){const t={},n=c.split(";").map((t=>{const[n,o,e,i,r,c,s]=t.split(" ");return{id:n,x:Number(o),y:Number(e),angleVelocity:Number(i),isAntiClockwise:!!r,color:c,opacity:Number(s)}}));for(const{id:o,x:e,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a}of n)t[o]={x:e,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a};return t}();let l=a;for(;l.length;){let t=[];for(const{id:n,dot:o}of l){const e=s[n];if(e)for(const n of e){const{x:e,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a}=u[n],l=o.appendDot({x:e,y:i});l.angleVelocity=r,l.isAntiClockwise=c,l.color=s,l.opacity=a,t.push({id:n,dot:l})}}l=t}return t}()),tt()},function(){t.click()}}();function rt(){const t=function(){const{createFirstIdDot:t,createFollowIdDot:n,getFirstIdDotArr:o,getFollowIdDotArr:e}=function(){let t=0;const n=[],o=[];return{createFirstIdDot:function(o){const e={id:t,dot:o};return n.push(e),t++,e},getFirstIdDotArr:function(){return n},createFollowIdDot:function(n){const e={id:t,dot:n};return o.push(e),t++,e},getFollowIdDotArr:function(){return o}}}(),i=function(){const o=[];let e=st().map((({firstDot:n})=>t(n)));for(;e.length;){let t=[];for(const{dot:i,id:r}of e){const e=i.followDots.map(n);o.push({id:r,followIds:e.map((({id:t})=>t))}),t=t.concat(e)}e=t}return o}();return[function(){let t=[];for(const{id:n,followIds:o}of i)o.length&&t.push(`${n} ${o.join(",")}`);return t.join(";")}(),o().map((({id:t,dot:n})=>{const{x:o,y:e}=n;return[t,o,e].join(" ")})).join(";"),e().map((({id:t,dot:n})=>{const{x:o,y:e,angleVelocity:i,isAntiClockwise:r,color:c,opacity:s}=n;return[t,o,e,i,r?"1":"",c,s].join(" ")})).join(";")].join("\n")}();S("data.ZenTrailsWeb",function(t){return`data:text/plain;base64,${btoa(encodeURIComponent(t))}`}(t))}let ct=[];function st(){return ct}function at(t){ct=t}function ut(){tt()}function lt(t,n){t.drawWhiteShadow();const o=B();ct.forEach((n=>{n.updateCartoonPath(),n.drawCartoonPath(t),n.drawCartoonPath(o)})),n.clearCanvas(),dt(n)}function dt(t){ct.forEach((n=>{n.drawPathDots(t)}))}function ft(){return void 0!==Y()}function ht(t){!function(t){Q(Y().appendDot(t))}(t)}let pt=v((function(){return document.getElementById("clear-btn")}),(t=>pt=t));function _t(){at([]),tt(),j()}const wt=function(){const t=T(),n=q(),o=n.getImageData(t);F(),n.putImageData(o)};function gt(){const t=function(t,n,o){let e;return o=o||100,function(){clearTimeout(e);const i=arguments;e=setTimeout((function(){n.apply(t,i)}),o)}}(this,wt);window.addEventListener("resize",t)}function mt(){j();const t=q();dt(t),function(t){const n=Y();void 0!==n&&t.drawTargetDot(n)}(t)}let vt=v((function(){return document.getElementById("export-picture-btn")}),(t=>vt=t));function yt(){const t=T(),n=B(),o=n.getImageData(t);n.drawWhiteShadow();const e=k().toDataURL("image/png");S("ZenTrailsWeb.png",e),n.putImageData(o)}let Dt=v((function(){return document.getElementById("cover")}),(t=>Dt=t));function xt(t){const n=N();if(n.clearCanvas(),m(t))return;const o=b(t);if(ft()){const t=Y(),e=c(o,t);n.drawMouseMoveFollowDot(e.position,t)}else{const t=nt(o);if(t)n.drawMouseMoveSelectDot(t);else{const t=r(o);n.drawMouseMoveFirstDot(t)}}}const{addCoverMouseMoveListener:Ct,removeCoverMouseMoveListener:Et}=function(){const t=function(t,n,o){let e;return o=o||100,function(){(void 0===e||Date.now()>e)&&(n.apply(t,arguments),e=Date.now()+o)}}(this,xt,20),n=Dt();return{addCoverMouseMoveListener:function(){n.addEventListener("mousemove",t)},removeCoverMouseMoveListener:function(){n.removeEventListener("mousemove",t)}}}();function Lt(){Ct(),function(){const t=Dt(),n=N();t.addEventListener("mouseout",(function(){n.clearCanvas()}))}()}let St,bt;function It(){St=requestAnimationFrame(kt)}function kt(){bt(),It()}let Pt=v((function(){return document.getElementById("start-btn")}),(t=>Pt=t)),Mt=v((function(){return document.getElementById("reset-btn")}),(t=>Mt=t));function Tt(){D(et()),D(ot()),D(Pt()),D(pt()),Et(),ut(),Rt(!0),It(),j();const t=q(),n=N();bt=lt.bind(this,t,n),x(vt()),x(Mt())}function Ft(){D(vt()),D(Mt()),Ct(),Rt(!1),cancelAnimationFrame(St),ct.forEach((t=>{t.reset()})),mt(),x(et()),x(ot()),x(Pt()),x(pt())}const{isPlayingCartoon:At,setIsPlayingCartoon:Rt}=function(){let t=!1;return{isPlayingCartoon:function(){return t},setIsPlayingCartoon:function(n){t=n}}}();const{__setupClickHandler:Wt,__execDblClickHandler:Bt}=function(){let t,n,o;function e(){ft()?ht(t):n&&Q(n)}return{__setupClickHandler:function(i){clearTimeout(o),t=b(i),n=nt(t);o=setTimeout(e,200)},__execDblClickHandler:function(){clearTimeout(o),n?Q(n):function(t){const n=new d(t);ct.push(n),Q(n.firstDot)}(t)}}}();function Nt(t){if(m(t)||At())return;0===t.button&&Wt(t)}function qt(t){if(m(t)||At())return;2===t.button&&ut()}function jt(t){if(m(t)||At())return;0===t.button&&Bt()}let Gt=v((function(){return document.getElementById("help")}),(t=>Gt=t)),Vt=v((function(){return document.querySelector("#help .help-ul")}),(t=>Vt=t));function $t(){D(Gt()),Xt()}function Ht(){x(Gt())}function Ut(){Vt().innerHTML=[{prompt:"通过 双击 空白区域可以开启新路径：",subPrompts:["通过 单击 可以增加后续节点；","通过 右击 可以结束当前路径。"]},{prompt:"点击 左下角 播放按钮可以开始播放动画：",subPrompts:["点击 左下角 重置按钮可以返回编辑节点；","点击 左下角 导出图片按钮可以导出轨迹图片。"]},{prompt:"通过 点击 可以选择节点，修改节点信息：",subPrompts:["通过 右下角 面板就可以修改节点信息；","通过 单击 可以继续增加后续节点。"]},{prompt:"未播放动画时，左下角会显示很多其他的功能按钮：",subPrompts:["点击 左下角 导出按钮可以将路径保存为本地数据；","点击 左下角 导入按钮可以读取存储的本地数据；","点击 左下角 清空按钮可以清空画布。"]},"祝你有一段快乐的 ZenTrailsWeb 之旅！"].map((function(t){if(void 0===t)return"";if("string"==typeof t)return`<li>${t}</li>`;if(t instanceof Object){const{prompt:n,subPrompts:o}=t;return`<li>\n${n}\n${function(t){return`<ul>${t.map((t=>`<li>${t}</li>`)).join("\n")}</ul>`}(o)}\n</li>`}})).join("\n");const t=Gt();w(t),t.addEventListener("click",$t)}const{__setGuideFin:Zt,__guideNotFin:Ot}=function(){const t="ZenTrailsWeb-guideFinKey";return{__setGuideFin:function(){localStorage.setItem(t,!0)},__guideNotFin:()=>!localStorage.getItem(t)}}();let Xt=function(){Qt("← 需要帮忙可以点击这里查看帮助信息"),Qt(""),Zt(),Xt=L};let Jt=v((function(){return document.querySelector("#prompt .i-wrapper")}),(t=>Jt=t)),zt=v((function(){return document.querySelector("#prompt .content")}),(t=>zt=t));const Kt=[],Yt=function(){const t=zt(),n="transparent";return()=>{0!==Kt.length&&(C(t,n),setTimeout((()=>{t.innerText=Kt[0],E(t,n),setTimeout((()=>{Kt.shift(),Kt.length&&setTimeout(Yt,1e3)}),500)}),500))}}();function Qt(t){0===Kt.length&&setTimeout(Yt),Kt.push(t)}setTimeout(F),function(){const t=pt();w(t),t.addEventListener("click",_t)}(),gt(),function(){const t=Dt();t.addEventListener("contextmenu",_),t.addEventListener("click",Nt),t.addEventListener("dblclick",jt),t.addEventListener("auxclick",qt),z(),Lt()}(),function(){const t=Pt();w(t),t.addEventListener("click",Tt);const n=Mt();w(n),n.addEventListener("click",Ft),function(){const t=vt();w(t),t.addEventListener("click",yt)}()}(),function(){const t=ot();w(t),t.addEventListener("click",it);const n=et();w(n),n.addEventListener("click",rt)}(),function(){const t=Jt();w(t),t.addEventListener("click",Ht),Ut(),Ot()?Ht():setTimeout(Xt)}(),Qt("加载完成")}()}();