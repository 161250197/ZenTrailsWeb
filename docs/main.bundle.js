!function(){"use strict";var t={245:function(t){t.exports=JSON.parse('{"dotRadius":5,"defaultColor":"#888888"}')}},n={};function e(o){var i=n[o];if(void 0!==i)return i.exports;var r=n[o]={exports:{}};return t[o](r,r.exports,e),r.exports}!function(){function t(t){return t*Math.PI/180}function n({x:t,y:n},e,o,i=0){o+=i;const r=t-e.x,c=n-e.y;return o*o>=r*r+c*c}function o(t,n){return function(t){return 180*t/Math.PI}(function(t,n){const e=n.x-t.x,o=n.y-t.y;let i=Math.atan(o/e);return e<0&&(i+=Math.PI),i}(t,n))}function i(n,e,o){const{x:i,y:r}=n,c=t(e);return{x:i+Math.cos(c)*o,y:r+Math.sin(c)*o}}function r(t){function n(t){return 10*Math.round(t/10)}let{x:e,y:o}=t;return e=n(e),o=n(o),{x:e,y:o}}function c(t,n){let e=(r=n,c=t,Math.sqrt(function(t,n){const e=n.x-t.x,o=n.y-t.y;return e*e+o*o}(r,c)));var r,c,s;s=e,e=10*Math.ceil(s/10);let a=o(n,t);return a=function(t,n){const e=[50,100,200];let o=0;for(;o<e.length&&e[o]<n;)o++;const i=[30,15,10,5][o];return Math.round(t/i)*i}(a,e),{position:t=i(n,a,e),radius:e,angle:a}}const{defaultColor:s}=e(245),{getLastColor:a,setLastColor:u}=function(){let t=s;return{getLastColor:function(){return t},setLastColor:function(n){t=n}}}(),{dotRadius:l}=e(245);class d{constructor(t){const n=r(t);this.firstDot=new h(n,this)}selectDot(t){const e=[],o=2*l,{firstDot:i}=this;n(t,i,o)&&e.push(i);let r=[i];for(;r.length;){let i=[];for(const t of r)i=i.concat(t.followDots);r=i;for(const i of r)n(t,i,o)&&e.push(i)}return e}reset(){let t=[this.firstDot];for(;t.length;){let n=[];for(const e of t)n=n.concat(e.followDots);t=n;for(const n of t)n.reset()}}updateCartoonPath(){let t=this.firstDot.followDots;for(;t.length;){let n=[];for(const e of t)n=n.concat(e.followDots),e.updateDurationState(10);t=n}}drawCartoonPath(t){let n=this.firstDot.followDots;for(;n.length;){let e=[];for(const o of n)e=e.concat(o.followDots),o.drawCartoonPath(t);n=e}}drawPathDots(t){const{firstDot:n}=this;t.drawPathFirstDot(n);let e=n.followDots;for(;e.length;){let n=[];for(const o of e)n=n.concat(o.followDots),t.drawPathFollowDot(o);e=n}}}class f{constructor({x:t,y:n}){this.x=t,this.y=n,this.followDots=[],this.isTarget=!1,this.opacity=1}appendDot(t){const n=c(t,this),e=new p(n,this);return this.followDots.push(e),e}removeDot(){throw Error("removeDot 未实现")}}class h extends f{constructor(t,n){super(t),this.path=n}removeDot(){!function(t){const n=ct.indexOf(t);ct.splice(n,1)}(this.path)}}class p extends f{constructor({position:t,radius:n,angle:e},o){super(t),this.radius=n,this.angle=e,this.angleVelocity=10,this.isAntiClockwise=!1,this.color=a(),this.lastDot=o;const{x:i,y:r}=t;this.__initialState={x:i,y:r,angle:e}}reset(){this.setState(this.__initialState)}setState({x:t,y:n,angle:e}){this.x=t,this.y=n,this.angle=e}removeDot(){const t=this.lastDot.followDots,n=t.indexOf(this);return t.splice(n,1),this.lastDot}drawCartoonPath(t){t.drawCartoonPath(this,this.__lastState)}updateDurationState(t){this.__saveLastState();const n=this.__calDurationState(t);this.setState(n)}__saveLastState(){const{x:t,y:n,angle:e}=this;this.__lastState={x:t,y:n,angle:e}}__calDurationState(t){const{radius:n,angleVelocity:e,lastDot:o}=this,r=e*t/100,c=this.angle+(this.isAntiClockwise?-r:r),{x:s,y:a}=i(o,c,n);return{x:s,y:a,angle:c}}}function _(t){return g(t),t.preventDefault(),t.stopPropagation(),!1}function w(t){t.addEventListener("click",g),t.addEventListener("auxclick",g),t.addEventListener("dblclick",g),t.addEventListener("mousemove",g)}function g(t){t.__eventUsed=!0}function m(t){return!!t.__eventUsed}function v(t,n){return function(){const e=t();return n((function(){return e})),e}}const D="hide";function y(t){C(t,D)}function x(t){E(t,D)}function C(t,n){t.classList.add(n)}function E(t,n){t.classList.remove(n)}function L(){}const S=function(){const t=document.createElement("a");return(n,e)=>{t.download=n,t.href=e,t.click()}}();function I(t){const{clientX:n,clientY:e}=t.touches&&t.touches[0]?t.touches[0]:t;return{x:n,y:e}}let k=v((function(){return document.getElementById("canvas-wrapper")}),(t=>k=t)),b=v((function(){return document.getElementById("export-canvas")}),(t=>b=t)),M=v((function(){return document.getElementById("up-canvas")}),(t=>M=t)),P=v((function(){return document.getElementById("down-canvas")}),(t=>P=t));function T(){const t=k(),{offsetWidth:n,offsetHeight:e}=t;return{width:n,height:e}}function F(){const{width:t,height:n}=T();[b(),P(),M()].forEach((e=>{e.width=t,e.height=n,function(t,n){const e=n instanceof Array?n.join("; "):n;t.setAttribute("style",e)}(e,[`width: ${t}px`,`height: ${n}px`])}))}const{dotRadius:A,defaultColor:R}=e(245);class W{constructor(t){const n=t.getContext("2d");n.lineJoin="round",n.lineWidth=3,this.__ctx=n}__drawLine(t,n){this.startPath(t),this.concatDot(n),this.closePath()}__drawCircle({x:t,y:n},e,o=0,i=2*Math.PI,r){const{__ctx:c}=this;c.beginPath(),c.arc(t,n,e,o,i,r),c.stroke(),c.closePath()}__createDotRadialGradient({x:t,y:n,color:e=R}){const o=A,i=this.__ctx.createRadialGradient(t,n,0,t,n,o);return i.addColorStop(0,"#bbbbbb"),i.addColorStop(.2,e),i.addColorStop(.8,e),i.addColorStop(.9,"white"),i.addColorStop(.9,"transparent"),i}__createDotLinearGradient({x:t,y:n,color:e,lastDot:o}){const i=o.color||R,r=this.__ctx.createLinearGradient(o.x,o.y,t,n);return r.addColorStop(0,i),r.addColorStop(.2,i),r.addColorStop(.8,e),r.addColorStop(1,e),r}__drawDotFunc(t){const{__ctx:n}=this;n.save(),n.fillStyle=this.__createDotRadialGradient(t);const{x:e,y:o,opacity:i}=t;n.globalAlpha=i,n.fillRect(e-A,o-A,2*A,2*A),n.restore()}__drawLastDotToDotLine(t){const{__ctx:n}=this;n.save(),n.lineWidth=1,n.globalAlpha=.6,n.strokeStyle=this.__createDotLinearGradient(t),this.__drawLine(t.lastDot,t),n.restore()}__drawDotDirection(n){const{__ctx:e}=this;e.save();const{color:o,angle:i,isAntiClockwise:r}=n,c=t(i),s=c+Math.PI/6,a=c+Math.PI;e.strokeStyle=o,e.lineWidth=5,this.__drawCircle(n,A,s,a,r),e.strokeStyle="white",e.lineWidth=1,this.__drawCircle(n,A,s,a,r),e.restore()}drawMouseMoveSelectDot(t){const{__ctx:n}=this;n.save(),this.drawTargetDot(t,.4),n.restore()}drawMouseMoveFollowDot(t,n){const{__ctx:e}=this;e.save();const o={...t,color:a(),opacity:.6,lastDot:n};this.__drawLastDotToDotLine(o),this.__drawDotFunc(o),this.drawTargetDot(o,.4),e.restore()}drawMouseMoveFirstDot(t){const{__ctx:n}=this;n.save();const e={...t,color:R,opacity:.6};this.__drawDotFunc(e),this.drawTargetDot(e,.4),n.restore()}drawTargetDot(t,n){const{__ctx:e}=this;e.save(),e.lineWidth=5,e.globalAlpha=n||.6,e.strokeStyle=t.color||R,this.__drawCircle(t,A),e.lineWidth=1,e.strokeStyle="white",this.__drawCircle(t,A),e.restore()}drawPathFirstDot(t){this.__drawDotFunc(t)}drawPathFollowDot(t){this.__drawLastDotToDotLine(t),this.__drawDotDirection(t),this.__drawDotFunc(t)}drawCartoonPath(t,n){const{__ctx:e}=this;e.save();const{color:o,opacity:i}=t;e.strokeStyle=o,e.globalAlpha=i,this.__drawLine(t,n),e.restore()}startPath({x:t,y:n}){const{__ctx:e}=this;e.beginPath(),e.moveTo(t,n)}concatDot({x:t,y:n}){const{__ctx:e}=this;e.lineTo(t,n),e.stroke()}closePath(){this.__ctx.closePath()}clearCanvas(){const t=Number.MAX_SAFE_INTEGER;this.__ctx.clearRect(0,0,t,t)}drawWhiteShadow(){const{__ctx:t}=this;t.save(),t.fillStyle="white",t.globalAlpha=.01;const n=Number.MAX_SAFE_INTEGER;t.fillRect(0,0,n,n),t.restore()}getImageData({width:t,height:n}){return this.__ctx.getImageData(0,0,t,n)}putImageData(t){this.__ctx.putImageData(t,0,0)}}let B=v((function(){return new W(b())}),(t=>B=t)),N=v((function(){return new W(M())}),(t=>N=t)),q=v((function(){return new W(P())}),(t=>q=t));function G(){B().clearCanvas(),N().clearCanvas(),q().clearCanvas()}let V,j=v((function(){return document.getElementById("setting-wrapper")}),(t=>j=t)),H=v((function(){return document.querySelector("#setting-wrapper .color")}),(t=>H=t)),U=v((function(){return document.querySelector("#setting-wrapper .opacity")}),(t=>U=t)),$=v((function(){return document.querySelector("#setting-wrapper .direction")}),(t=>$=t)),Z=v((function(){return document.querySelector("#setting-wrapper .velocity")}),(t=>Z=t)),O=v((function(){return document.querySelector("#setting-wrapper .remove")}),(t=>O=t)),X=v((function(){return document.querySelector("#setting-wrapper .first-dot-setting")}),(t=>X=t)),J=v((function(){return document.querySelector("#setting-wrapper .follow-dot-setting")}),(t=>J=t));function z(){w(j());H().addEventListener("input",(t=>{const n=t.target.value;Y().color=n,u(n),mt()}),!1);U().addEventListener("input",(t=>{const n=t.target.value;Y().opacity=n/100,mt()}));$().addEventListener("click",(()=>{const t=Y();t.isAntiClockwise=!t.isAntiClockwise,K(t),mt()}));Z().addEventListener("input",(t=>{const n=t.target.value;Y().angleVelocity=n}));O().addEventListener("click",(()=>{!function(){if(void 0===V)return;const t=V.removeDot();void 0===t?tt():Q(t)}()}))}function K(t){const n=$(),e="is-clockwise",o="is-anti-clockwise";E(n,e),E(n,o),C(n,t.isAntiClockwise?o:e)}function Y(){return V}function Q(t){var n;void 0!==V&&(V.isTarget=!1),V=t,V instanceof h?(y(J()),x(X()),x(j())):(n=V,H().value=n.color,U().value=100*n.opacity,K(n),Z().value=n.angleVelocity,y(X()),x(J()),x(j())),V.isTarget=!0,mt()}function tt(){void 0!==V?(V.isTarget=!1,y(j()),V=void 0,mt()):mt()}function nt(t){let n=[];const e=st();for(const o of e)n=n.concat(o.selectDot(t));let o;return n.length&&(o=n[0]),o}let et=v((function(){return document.getElementById("data-upload-btn")}),(t=>et=t)),ot=v((function(){return document.getElementById("data-save-btn")}),(t=>ot=t));const it=function(){const t=document.createElement("input");t.type="file",t.accept=".ZenTrailsWeb",t.addEventListener("change",(function(){if(0===t.files.length)return;const e=t.files[0];n.readAsText(e),t.value=null}));const n=new FileReader;return n.onload=function(){at(function(){const t=[],e=(o=n.result,decodeURIComponent(o));var o;const[i,r,c]=e.split("\n"),s=function(){const t={},n=i.split(";").map((t=>{const[n,e]=t.split(" ");return{id:n,followIds:e.split(",")}}));for(const{id:e,followIds:o}of n)t[e]=o;return t}(),a=r.split(";").map((n=>{const[e,o,i]=n.split(" "),r=Number(o),c=Number(i),s=new d({x:r,y:c});return t.push(s),{id:e,dot:s.firstDot}})),u=function(){const t={},n=c.split(";").map((t=>{const[n,e,o,i,r,c,s]=t.split(" ");return{id:n,x:Number(e),y:Number(o),angleVelocity:Number(i),isAntiClockwise:!!r,color:c,opacity:Number(s)}}));for(const{id:e,x:o,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a}of n)t[e]={x:o,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a};return t}();let l=a;for(;l.length;){let t=[];for(const{id:n,dot:e}of l){const o=s[n];if(o)for(const n of o){const{x:o,y:i,angleVelocity:r,isAntiClockwise:c,color:s,opacity:a}=u[n],l=e.appendDot({x:o,y:i});l.angleVelocity=r,l.isAntiClockwise=c,l.color=s,l.opacity=a,t.push({id:n,dot:l})}}l=t}return t}()),tt()},function(){t.click()}}();function rt(){const t=function(){const{createFirstIdDot:t,createFollowIdDot:n,getFirstIdDotArr:e,getFollowIdDotArr:o}=function(){let t=0;const n=[],e=[];return{createFirstIdDot:function(e){const o={id:t,dot:e};return n.push(o),t++,o},getFirstIdDotArr:function(){return n},createFollowIdDot:function(n){const o={id:t,dot:n};return e.push(o),t++,o},getFollowIdDotArr:function(){return e}}}(),i=function(){const e=[];let o=st().map((({firstDot:n})=>t(n)));for(;o.length;){let t=[];for(const{dot:i,id:r}of o){const o=i.followDots.map(n);e.push({id:r,followIds:o.map((({id:t})=>t))}),t=t.concat(o)}o=t}return e}();return[function(){let t=[];for(const{id:n,followIds:e}of i)e.length&&t.push(`${n} ${e.join(",")}`);return t.join(";")}(),e().map((({id:t,dot:n})=>{const{x:e,y:o}=n;return[t,e,o].join(" ")})).join(";"),o().map((({id:t,dot:n})=>{const{x:e,y:o,angleVelocity:i,isAntiClockwise:r,color:c,opacity:s}=n;return[t,e,o,i,r?"1":"",c,s].join(" ")})).join(";")].join("\n")}();S("data.ZenTrailsWeb",function(t){return`data:text/plain;base64,${btoa(encodeURIComponent(t))}`}(t))}let ct=[];function st(){return ct}function at(t){ct=t}function ut(){tt()}function lt(t,n){t.drawWhiteShadow();const e=B();ct.forEach((n=>{n.updateCartoonPath(),n.drawCartoonPath(t),n.drawCartoonPath(e)})),n.clearCanvas(),dt(n)}function dt(t){ct.forEach((n=>{n.drawPathDots(t)}))}function ft(){return void 0!==Y()}function ht(t){!function(t){Q(Y().appendDot(t))}(t)}let pt=v((function(){return document.getElementById("clear-btn")}),(t=>pt=t));function _t(){at([]),tt(),G()}const wt=function(){const t=T(),n=q(),e=n.getImageData(t);F(),n.putImageData(e)};function gt(){const t=function(t,n,e){let o;return e=e||100,function(){clearTimeout(o);const i=arguments;o=setTimeout((function(){n.apply(t,i)}),e)}}(this,wt);window.addEventListener("resize",t)}function mt(){G();const t=q();dt(t),function(t){const n=Y();void 0!==n&&t.drawTargetDot(n)}(t)}let vt=v((function(){return document.getElementById("export-picture-btn")}),(t=>vt=t));function Dt(){const t=T(),n=B(),e=n.getImageData(t);n.drawWhiteShadow();const o=b().toDataURL("image/png");S("ZenTrailsWeb.png",o),n.putImageData(e)}let yt=v((function(){return document.getElementById("cover")}),(t=>yt=t));function xt(t){const n=N();if(n.clearCanvas(),m(t))return;const e=I(t);if(ft()){const t=Y(),o=c(e,t);n.drawMouseMoveFollowDot(o.position,t)}else{const t=nt(e);if(t)n.drawMouseMoveSelectDot(t);else{const t=r(e);n.drawMouseMoveFirstDot(t)}}}const{addCoverMouseMoveListener:Ct,removeCoverMouseMoveListener:Et}=function(){const t=function(t,n,e){let o;return e=e||100,function(){(void 0===o||Date.now()>o)&&(n.apply(t,arguments),o=Date.now()+e)}}(this,xt,20),n=yt();return{addCoverMouseMoveListener:function(){n.addEventListener("mousemove",t)},removeCoverMouseMoveListener:function(){n.removeEventListener("mousemove",t)}}}();function Lt(){Ct(),function(){const t=yt(),n=N();t.addEventListener("mouseout",(function(){n.clearCanvas()}))}()}let St,It;function kt(){St=requestAnimationFrame(bt)}function bt(){It(),kt()}let Mt=v((function(){return document.getElementById("start-btn")}),(t=>Mt=t)),Pt=v((function(){return document.getElementById("reset-btn")}),(t=>Pt=t));function Tt(){y(ot()),y(et()),y(Mt()),y(pt()),Et(),ut(),Rt(!0),kt(),G();const t=q(),n=N();It=lt.bind(this,t,n),x(vt()),x(Pt())}function Ft(){y(vt()),y(Pt()),Ct(),Rt(!1),cancelAnimationFrame(St),ct.forEach((t=>{t.reset()})),mt(),x(ot()),x(et()),x(Mt()),x(pt())}const{isPlayingCartoon:At,setIsPlayingCartoon:Rt}=function(){let t=!1;return{isPlayingCartoon:function(){return t},setIsPlayingCartoon:function(n){t=n}}}();const{__setupClickHandler:Wt,__execDblClickHandler:Bt}=function(){let t,n,e;function o(){ft()?ht(t):n&&Q(n)}return{__setupClickHandler:function(i){clearTimeout(e),t=I(i),n=nt(t);e=setTimeout(o,200)},__execDblClickHandler:function(){clearTimeout(e),n?Q(n):function(t){const n=new d(t);ct.push(n),Q(n.firstDot)}(t)}}}();function Nt(t){if(m(t)||At())return;0===t.button&&Wt(t)}function qt(t){if(m(t)||At())return;2===t.button&&ut()}function Gt(t){if(m(t)||At())return;0===t.button&&Bt()}let Vt=v((function(){return document.getElementById("help")}),(t=>Vt=t));function jt(){y(Vt()),Zt()}function Ht(){x(Vt())}const{__setGuideFin:Ut,__guideNotFin:$t}=function(){const t="ZenTrailsWeb-guideFinKey";return{__setGuideFin:function(){localStorage.setItem(t,!0)},__guideNotFin:()=>!localStorage.getItem(t)}}();let Zt=function(){Kt("← 需要帮忙可以点击这里查看帮助信息"),Kt(""),Ut(),Zt=L};let Ot=v((function(){return document.querySelector("#prompt .i-wrapper")}),(t=>Ot=t)),Xt=v((function(){return document.querySelector("#prompt .content")}),(t=>Xt=t));const Jt=[],zt=function(){const t=Xt(),n="transparent";return()=>{0!==Jt.length&&(C(t,n),setTimeout((()=>{t.innerText=Jt[0],E(t,n),setTimeout((()=>{Jt.shift(),Jt.length&&setTimeout(zt,1e3)}),500)}),500))}}();function Kt(t){0===Jt.length&&setTimeout(zt),Jt.push(t)}setTimeout(F),function(){const t=pt();w(t),t.addEventListener("click",_t)}(),gt(),function(){const t=yt();t.addEventListener("contextmenu",_),t.addEventListener("click",Nt),t.addEventListener("dblclick",Gt),t.addEventListener("auxclick",qt),z(),Lt()}(),function(){const t=Mt();w(t),t.addEventListener("click",Tt);const n=Pt();w(n),n.addEventListener("click",Ft),function(){const t=vt();w(t),t.addEventListener("click",Dt)}()}(),function(){const t=et();w(t),t.addEventListener("click",it);const n=ot();w(n),n.addEventListener("click",rt)}(),function(){const t=Ot();w(t),t.addEventListener("click",Ht),function(){const t=Vt();w(t),t.addEventListener("click",jt)}(),$t()?Ht():setTimeout(Zt)}(),Kt("加载完成")}()}();